## 銀行システム（コア機能）要件定義書 （RDB版）

### 1. はじめに

#### 1.1. 目的
本文書は、アプリケーション開発の学習を目的として、銀行システムのコア機能である「送金」を模倣したアプリケーションを開発する際の要件を定義するものです。特に、送金処理の技術的な仕様を明確にすることを目的とします。

#### 1.2. 範囲
本文書の範囲は、以下のエンティティおよび機能に限定します。
* **エンティティ:** 口座 (Account)、取引履歴 (Transaction)
* **機能:** 送金 (Transfer)

UI（ユーザーインターフェース）や認証機能、利息計算などの高度な機能は範囲外とします。

#### 1.3. 用語定義
| 用語 | 説明 |
| :--- | :--- |
| **エンティティ** | システムが管理するデータのまとまり。データベースのテーブルに相当します。 |
| **トランザクション** | 関連する一連の処理を一つの処理単位としてまとめたもの。全て成功するか、全て失敗するかのどちらかの結果しか許容しません。 |
| **ACID特性** | データベースのトランザクション処理に求められる4つの性質（原子性、一貫性、独立性、永続性）のことです。 |
| **ロールバック** | トランザクション処理中にエラーが発生した場合に、処理開始前の状態にデータを復元することです。 |

---

### 2. データ要件（エンティティ定義）

システムの基礎となるデータ構造を以下のように定義します。

#### 2.1. 口座エンティティ (Account)
顧客の口座情報を管理します。

| 項目名 | データ型 | 説明 | 制約 |
| :--- | :--- | :--- | :--- |
| `account_id` | 文字列 | システム内で一意に口座を識別するID | 主キー |
| `account_number` | 文字列 | 利用者が使用する口座番号 | 一意 |
| `holder_name` | 文字列 | 口座名義人名 | Not Null |
| `balance` | 数値型 (Decimal) | 残高 | Not Null, 0以上 |
| `created_at` | 日時型 | データ作成日時 | |
| `updated_at` | 日時型 | データ更新日時 | |

#### 2.2. 取引履歴エンティティ (Transaction)
お金の移動履歴を記録します。

| 項目名 | データ型 | 説明 | 制約 |
| :--- | :--- | :--- | :--- |
| `transaction_id` | 文字列 | 一意に取引を識別するID | 主キー |
| `account_id` | 文字列 | この取引に関連する口座のID | 外部キー (Account) |
| `transaction_type` | 文字列 | 取引種別 (`DEPOSIT`: 入金, `WITHDRAWAL`: 出金) | Not Null |
| `amount` | 数値型 (Decimal) | 取引金額（常に正の値） | Not Null, 0より大きい |
| `counterparty_account_number` | 文字列 | 取引相手の口座番号 | |
| `transaction_datetime` | 日時型 | 取引実行日時 | Not Null |

---

### 3. 機能要件

#### 3.1. 送金機能 (FR-001)

##### 3.1.1. 概要
指定された送金元口座から送金先口座へ、指定された金額を移動させる機能です。この処理は、**データの整合性を絶対に保つ**必要があります。

##### 3.1.2. 入力
| 項目 | データ型 | 説明 |
| :--- | :--- | :--- |
| `source_account_number` | 文字列 | 送金元の口座番号 |
| `destination_account_number` | 文字列 | 送金先の口座番号 |
| `amount` | 数値型 | 送金金額 |

##### 3.1.3. 処理フロー
送金処理は、以下のステップを**一つのトランザクション**として実行します。これにより、処理の途中でエラーが発生した場合、全ての変更が取り消され（ロールバック）、処理前の状態が保たれます（**原子性: Atomicity**）。

1.  **バリデーションチェック**
    1.  送金元口座 (`source_account_number`) と送金先口座 (`destination_account_number`) がデータベースに存在することを確認します。
    2.  送金元口座と送金先口座が同一でないことを確認します。
    3.  送金金額 (`amount`) が1以上の正の数値であることを確認します。
    4.  **【重要】** 送金元口座の残高 (`balance`) が送金金額 (`amount`) 以上であることを確認します（残高不足チェック）。
    * これらのチェックで問題があれば、エラーを返し処理を中断します。

2.  **トランザクション開始**
    * データベースのトランザクション処理を開始します。

3.  **送金元口座の残高を減算**
    * `Account` テーブルから送金元口座のレコードを取得し、`balance` から `amount` を引きます。
    * SQL例: `UPDATE accounts SET balance = balance - :amount WHERE account_number = :source_account_number;`

4.  **送金先口座の残高を加算**
    * `Account` テーブルから送金先口座のレコードを取得し、`balance` に `amount` を足します。
    * SQL例: `UPDATE accounts SET balance = balance + :amount WHERE account_number = :destination_account_number;`

5.  **取引履歴の記録**
    1.  **出金履歴の作成:** `Transaction` テーブルに、送金元の出金履歴を記録します。
        * `transaction_type`: `WITHDRAWAL`
        * `account_id`: 送金元口座のID
        * `amount`: 送金金額
        * `counterparty_account_number`: 送金先口座番号
    2.  **入金履歴の作成:** `Transaction` テーブルに、送金先の入金履歴を記録します。
        * `transaction_type`: `DEPOSIT`
        * `account_id`: 送金先口座のID
        * `amount`: 送金金額
        * `counterparty_account_number`: 送金元口座番号

6.  **トランザクション確定 (コミット)**
    * ステップ3〜5の全ての処理が成功した場合、データベースへの変更を確定します。

##### 3.1.4. 出力
* **成功時:** 取引が正常に完了したことを示すメッセージ、または取引IDを返します。
* **失敗時:** バリデーションエラーや処理中のエラーに応じたエラーメッセージ（例: 「残高が不足しています」、「送金先口座が存在しません」）を返します。

---

### 4. 非機能要件

#### 4.1. 信頼性
* **ACID特性の保証:** 送金処理はACID特性、特に**原子性 (Atomicity)** と**一貫性 (Consistency)** を保証しなければなりません。
    * **原子性:** 送金（残高の増減と履歴の記録）は、全て成功するか、全て失敗するかのいずれかでなければなりません。
    * **一貫性:** トランザクションの前後で、システム全体の資産総額が変わらないなど、データの整合性が保たれている必要があります。
* **排他制御:** 同時に同じ口座へ複数の送金処理が実行された場合でも、データの不整合が発生しないように、適切なロック（例: 行ロック）をかけて処理を行う必要があります（**独立性: Isolation**）。

#### 4.2. 性能
* 通常の負荷状況において、一件の送金処理が2秒以内に完了することを目指します。